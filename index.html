<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>AA制图器</title>
    <style>
        input {
            font-size: 16px;
            line-height: 18px;
            white-space: normal;
            width: 80vw;
        }
    </style>
</head>

<body>

    <table>
        <tr>
            <td>
                <textarea rows="5" cols="130" name="text" placeholder="Input your AA" id="aaText"></textarea>
                <canvas hidden id="aaCanvas"></canvas>
            </td>
        </tr>
        <tr>
            <td>
                <img id="resultedImage">
            </td>
        </tr>
    </table>

    <script>

        function getWidthOfText(txt, fontname, fontsize) {
            if (getWidthOfText.c === undefined) {
                getWidthOfText.c = document.createElement('canvas');
                getWidthOfText.ctx = getWidthOfText.c.getContext('2d');
            }
            var fontspec = fontsize + ' ' + fontname;
            if (getWidthOfText.ctx.font !== fontspec)
                getWidthOfText.ctx.font = fontspec;
            return getWidthOfText.ctx.measureText(txt).width;
        }

        function refreshInputText(INPUT_PROPERTY,fontsize,thefont) {
            INPUT_PROPERTY.TEXT_value = INPUT_PROPERTY.TEXT_self.value;
            INPUT_PROPERTY.LINES_oftext = INPUT_PROPERTY.TEXT_value.split('\n');
            INPUT_PROPERTY.WIDTH_ofeachline = INPUT_PROPERTY.LINES_oftext.map(function (text) { return getWidthOfText(text,`${thefont}`,`${fontsize}px`); });
            return INPUT_PROPERTY;
        }


        var inputTextObject = {
            TEXT_self: document.getElementById('aaText')
        };

        var canvasObject = {
            CONTEXT: document.getElementById('aaCanvas').getContext('2d'),
            THECANVAS: document.getElementById('aaCanvas').getContext('2d').canvas
        };

        var imageElem = document.getElementById('resultedImage');
        var usedFont= "MS PGothic"
        var usedFontLineHeight = 18;
        var usedFontWidth= 16;
        var leftAlignedOffset = 10;

        document.getElementById('aaText').addEventListener('input', function () {

            inputTextObject = refreshInputText(inputTextObject,usedFontWidth,usedFont);

            canvasObject.THECANVAS.width = Math.max.apply(null, inputTextObject.WIDTH_ofeachline) + leftAlignedOffset;
            canvasObject.THECANVAS.height = inputTextObject.LINES_oftext.length * usedFontLineHeight + usedFontLineHeight;
            canvasObject.THECANVAS.globalCompositeOperation = "source-over";
            canvasObject.CONTEXT.fillStyle = "#FFFFFF";
            canvasObject.CONTEXT.fillRect(0, 0, canvasObject.THECANVAS.width, canvasObject.THECANVAS.height);
            canvasObject.CONTEXT.fillStyle = "#1E1E1E";
            canvasObject.CONTEXT.font = "16px MS PGothic";

            for (var i = 0; i < inputTextObject.LINES_oftext.length; i++) {
                canvasObject.CONTEXT.fillText(inputTextObject.LINES_oftext[i], leftAlignedOffset, usedFontLineHeight * (i + 2));
            }

            imageElem.src = canvasObject.THECANVAS.toDataURL();

        }, false);

    </script>

</body>

</html>
